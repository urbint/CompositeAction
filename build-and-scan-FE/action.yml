name: Build and Scan Docker Image

description: Build a Docker image and scan it for vulnerabilities using Trivy.
inputs:
  image_name:
    description: 'The name and tag of the Docker image (e.g., my-image:latest).'
    required: true
  dockerfile:
    description: 'Path to the Dockerfile.'
    required: true
    default: 'Dockerfile'
  context:
    description: 'Build context path.'
    required: true
    default: '.'  # Default to current directory
  node-version:
    description: 'Node.js version to use'
    required: true
    default: '20'  # Default Node.js version
  registry-url:
    description: 'Registry URL for NPM packages'
    required: true
    default: 'https://npm.pkg.github.com'  # Default registry URL
  node-auth-token:
    description: 'NPM Auth Token for accessing private packages'
    required: true
    default: ''  # Default can be blank

runs:
  using: 'composite'
  steps:
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ inputs.node-version }}
        registry-url: ${{ inputs.registry-url }}  # Pass the registry URL

    - name: Install dependencies
      run: |
        yarn install
      env:
        NODE_AUTH_TOKEN: ${{ inputs.node-auth-token }}  # Use the provided auth token
      shell: bash  # Specify the shell for this step

    - name: Build the application
      run: |
        yarn build  # Add the build step
      shell: bash  # Specify the shell for this step
    
    - name: Build and Scan
      uses: urbint/github-actions-library/build-and-scan@feature/usable
      with: 
        image_name: ${{ inputs.image_name }} 
        dockerfile: ${{ inputs.dockerfile }} 
        context: ${{ inputs.context }} 